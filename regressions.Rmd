---
title: "regressions"
author: "Maria Heeter"
date: "3/16/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(censusapi)
library(tidycensus)
library(tidyverse)
library(viridis)
library(dplyr)
library(tidyr)
library(reshape2)
# maps 
library(maps)
library(usmap)
library(ggplot2)
# regressions 
library(AER)
library(dynlm)
library(forecast)
library(readxl)
library(stargazer)
library(scales)
library(quantmod)
library(urca)
library(Formula)
library(plm)
library(sandwich)
```
 
# iLoading in data 

```{r}
# load in df 
df <- read.csv("thesisDF.csv")
view(df)
```

# Initial basic modeling

```{r, results='hide'}

# transform data 
df_reg <- pdata.frame(df, index="date")
index(df_reg) # checks ts ... seems wrong(?) 

# simple plm model as a test, index as fips code 
simpletestFips <- plm(rent_perc_change_nominal ~ rent_price_ratio, data=df, index="fips", model="within")
simpletestFips

# test with index as year 
simpletestYr <- plm(rent_perc_change_nominal ~ rent_price_ratio, data=df, index="year", model="within")
simpletestYr

```

# Estimating simple reg model using 2009 data 

```{r}
# subset the data 
rentPriceRatio2010 <- subset(df, year == "2010")
rentPriceRatio2012 <- subset(df, year == "2012")

# estimate simple reg models 
reg2010sub <- lm(rent_perc_change_nominal ~ rent_price_ratio, data=rentPriceRatio2010)
reg2012sub <- lm(rent_perc_change_nominal ~ rent_price_ratio, data=rentPriceRatio2012)

# t tests 
coeftest(reg2010sub, vcov. = vcovHC, type="HC1")
coeftest(reg2012sub, vcov. = vcovHC, type="HC1")

# viz of first reg line 
plot(x = rentPriceRatio2010$rent_price_ratio, y = rentPriceRatio2010$real_rent_perc_growth, xlab = "Rent-Price Ratio (2010)", ylab = "Real Rent Percent Growth Rate (2010)", ylim = c(0, .4), pch = 20, col = "steelblue")
abline(reg2010sub, lwd = 1.5)

# viz of second 
plot(x = rentPriceRatio2012$rent_price_ratio, y = rentPriceRatio2012$real_rent_perc_growth, xlab = "Rent-Price Ratio (2012)", ylab = "Real Rent Percent Growth Rate (2012)", ylim = c(0, .4), pch = 20, col = "steelblue")
abline(reg2012sub, lwd = 1.5)

# note: see for info: https://www.econometrics-with-r.org/10.1-panel-data.html
```

# Plm fixed effects regression 

```{r}
# question: is the real_rent_perc_growth correct for the year? would it be one ahead? 
mod <- plm(rent_perc_change_nominal ~ rent_price_ratio, data=df, index=c("date", "fips"), model='within')
coeftest(mod, vcov.=vcovHC, type="HC1")

# try again w na's omited 
mod <- plm(rent_perc_change_nominal ~ rent_price_ratio, data=df, index=c("date", "fips"), model='within')
coeftest(mod, vcov.=vcovHC, type="HC1")

# est coeff is .007 -- the coeff on _ is negative and significant. the interpretation is that the est reduction in rent perc growth due to an increase in the rent_price_ratio by 1 is .007. "although including [fips] fixed effects eliminates the risk of a bias due to omitted factors that vary across states but not over time, we suspect that there are other omitted variables that vary over time and thus cause a bias."

# general reg plot & reg line 
plot(x = df$rent_price_ratio, y = df$rent_perc_change_nominal, xlab = "Rent-Price Ratio (2009 - 2019)", ylab = "Real Rent Percent Growth Rate (2009 - 2019)", ylim = c(0, .4), pch = 20, col = "steelblue")
abline(mod, lwd = 1.5)
```

# Estimating combined time and entity fixed eff reg model 

```{r}
lm_mod <- lm(rent_perc_change_nominal ~ rent_price_ratio + fips + year - 1, data=df)
lm_mod

# model via plm 
lm_mod_plm <- plm(rent_perc_change_nominal ~ rent_price_ratio, data = df, index = c("fips", "year"), model="within", effect="twoways")
coeftest(lm_mod_plm, vcov=vcovHC, type="HC1")

# before disc outcomes remind that state and year are of class factor 
class(df$fips)
class(df$year)

# changes to factor using test dataset 
dfTEST <- df 
dfTEST$fips <- as.factor(df$fips)
dfTEST$year <- as.factor(df$year)
class(dfTEST$year)

# tries again 
lm_mod_plm <- plm(rent_perc_change_nominal ~ rent_price_ratio, data = dfTEST, index = c("fips", "year"), model="within", effect="twoways")
coeftest(lm_mod_plm, vcov=vcovHC, type="HC1") # note: twoways includes entity and time dummies. adds the addtl regressor year for time fixed effects. 

# plots above model 
plot(x = dfTEST$rent_price_ratio, y = dfTEST$rent_perc_change_nominal, xlab = "Rent-Price Ratio (2009-2019)", ylab = "Real Rent Percent Growth Rate (2009-2019)", ylim = c(0, .4), pch = 20, col = "steelblue")
abline(lm_mod_plm, lwd = 1.5)

# see: https://www.econometrics-with-r.org/10.4-regression-with-time-fixed-effects.html

# obtains a summary based on clustered standard errors (plm). adjusts for autocorrelation AND heteroskedasticity. 
coeftest(lm_mod_plm, vcov=vcovHC, type="HC1")

# obtains a summary based on heteroskedasticity-robust standard errors (no adj for heterosked. only)
coeftest(lm_mod, vcov = vcovHC, type="HC1")[1,]

# checks class of both models 
class(lm_mod_plm) # panel 
class(lm_mod) # lm 

# now, discuss results: 
```
 
 # discussion of all seven models 
```{r}
mod1 <- lm(rent_perc_change_nominal ~ rent_price_ratio, data=df)
mod1

mod2 <- plm(rent_perc_change_nominal ~ rent_price_ratio + fips, index="fips", data=df) # note: i altered the code to make fips index... 
mod2

mod3 <- plm(rent_perc_change_nominal ~ rent_price_ratio + fips + year, index = c("fips", "year"), model = "within", effect="twoways", data=df)
mod3 

# in mod4, we want to include other county specific variables (we can pull this from the api!)
 
mod4 <- plm(rent_perc_change_nominal ~ rent_price_ratio + fips + year + population + housing_value + gini_income_inequality_index + household_type + bach_deg_reported + occupancy_status + vacancy_status + housing_units + twelve_mo_median_hh_income, index=c("fips", "year"), model="within", effect="twoways", data=df)
mod4

# plot 
plot(x = df$rent_price_ratio, y = df$rent_perc_change_nominal, xlab = "Rent-Price Ratio (2009 - 2019)", ylab = "Real Rent Percent Growth Rate (2009 - 2019)", ylim = c(0, .4), pch = 20, col = "steelblue")
abline(mod4, lwd = 8)

```

# Stargazer section: Generates a table

```{r}
# gather clustered standard errors in a list 

se <- list(sqrt(diag(vcovHC(mod1, type="HC1"))), sqrt(diag(vcovHC(mod2, type="HC1"))), sqrt(diag(vcovHC(mod3, type="HC1"))), sqrt(diag(vcovHC(mod4, type="HC1"))))

# generate the table 

# tableTEST <- stargazer(mod1, mod2, mod3, mod4, header=FALSE, se=se, title="Linear Panel Regression Models of Rent Growth and Rent-Price-Ratio", model.numbers=FALSE, column.labels=c("(1)", "(2)", "(3)", "(4)", type="latex", out="Documents/GitHub/econThesisSpring/stargazertest.htmL")) # file name and loc

tableTEST <- stargazer(mod1, mod2, mod3, mod4, title="Linear Panel Regression Models of Rent Growth and Rent-Price-Ratio", header=FALSE, se=se, type="html", out = "stargazerOutputTest.html")

tableTEST
```





