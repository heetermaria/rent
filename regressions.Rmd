---
title: "regressions"
author: "Maria Heeter"
date: "3/16/2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(censusapi)
library(tidycensus)
library(tidyverse)
library(viridis)
library(dplyr)
library(tidyr)
library(reshape2)
# maps 
library(maps)
library(usmap)
library(ggplot2)
# regressions 
library(AER)
library(dynlm)
library(forecast)
library(readxl)
library(stargazer)
library(scales)
library(quantmod)
library(urca)
library(Formula)
library(plm)
library(sandwich)
```
 
# loading in data 

```{r}
# load in df 
df <- read.csv("thesisDF.csv")
view(df)
```

# initial basic modeling

```{r, results='hide'}

# transform data 
df_reg <- pdata.frame(df, index="date")
index(df_reg) # checks ts ... seems wrong(?) 

# simple plm model as a test, index as fips code 
simpletestFips <- plm(rent_perc_change_nominal ~ rent_price_ratio, data=df, index="fips", model="within")
simpletestFips

# test with index as year 
simpletestYr <- plm(rent_perc_change_nominal ~ rent_price_ratio, data=df, index="year", model="within")
simpletestYr

```

# Estimating simple reg model using 2009 data 

```{r}
# subset the data 
rentPriceRatio2010 <- subset(df, year == "2010")
rentPriceRatio2012 <- subset(df, year == "2012")

# estimate simple reg models 
reg2010sub <- lm(rent_perc_change_nominal ~ rent_price_ratio, data=rentPriceRatio2010)
reg2012sub <- lm(rent_perc_change_nominal ~ rent_price_ratio, data=rentPriceRatio2012)

# t tests 
coeftest(reg2010sub, vcov. = vcovHC, type="HC1")
coeftest(reg2012sub, vcov. = vcovHC, type="HC1")

# viz of first reg line 
plot(x = rentPriceRatio2010$rent_price_ratio, y = rentPriceRatio2010$real_rent_perc_growth, xlab = "Rent-Price Ratio (2010)", ylab = "Real Rent Percent Growth Rate (2010)", ylim = c(0, .4), pch = 20, col = "steelblue")
abline(reg2010sub, lwd = 1.5)

# viz of second 
plot(x = rentPriceRatio2012$rent_price_ratio, y = rentPriceRatio2012$real_rent_perc_growth, xlab = "Rent-Price Ratio (2012)", ylab = "Real Rent Percent Growth Rate (2012)", ylim = c(0, .4), pch = 20, col = "steelblue")
abline(reg2012sub, lwd = 1.5)

# note: see for info: https://www.econometrics-with-r.org/10.1-panel-data.html
```

# Plm fixed effects regression 

```{r}
# question: is the real_rent_perc_growth correct for the year? would it be one ahead? 
mod <- plm(rent_perc_change_nominal ~ rent_price_ratio, data=df, index=c("date", "fips"), model='within')
coeftest(mod, vcov.=vcovHC, type="HC1")

# try again w na's omited 
mod <- plm(rent_perc_change_nominal ~ rent_price_ratio, data=df, index=c("date", "fips"), model='within')
coeftest(mod, vcov.=vcovHC, type="HC1")

# est coeff is .007 -- the coeff on _ is negative and significant. the interpretation is that the est reduction in rent perc growth due to an increase in the rent_price_ratio by 1 is .007. "although including [fips] fixed effects eliminates the risk of a bias due to omitted factors that vary across states but not over time, we suspect that there are other omitted variables that vary over time and thus cause a bias."

# general reg plot & reg line 
plot(x = df$rent_price_ratio, y = df$rent_perc_change_nominal, xlab = "Rent-Price Ratio (2009 - 2019)", ylab = "Real Rent Percent Growth Rate (2009 - 2019)", ylim = c(0, .4), pch = 20, col = "steelblue")
abline(mod, lwd = 1.5)
```

# Estimating combined time and entity fixed eff reg model 

```{r}
lm_mod <- lm(rent_perc_change_nominal ~ rent_price_ratio + fips + year - 1, data=df)
lm_mod

# model via plm 
lm_mod_plm <- plm(rent_perc_change_nominal ~ rent_price_ratio, data = df, index = c("fips", "year"), model="within", effect="twoways")
coeftest(lm_mod_plm, vcov=vcovHC, type="HC1")

# before disc outcomes remind that state and year are of class factor 
class(df$fips)
class(df$year)

# changes to factor using test dataset 
dfTEST <- df 
dfTEST$fips <- as.factor(df$fips)
dfTEST$year <- as.factor(df$year)
class(dfTEST$year)

# tries again 
lm_mod_plm <- plm(rent_perc_change_nominal ~ rent_price_ratio, data = dfTEST, index = c("fips", "year"), model="within", effect="twoways")
coeftest(lm_mod_plm, vcov=vcovHC, type="HC1") # note: twoways includes entity and time dummies. adds the addtl regressor year for time fixed effects. 

# plots above model 
plot(x = dfTEST$rent_price_ratio, y = dfTEST$rent_perc_change_nominal, xlab = "Rent-Price Ratio (2009-2019)", ylab = "Real Rent Percent Growth Rate (2009-2019)", ylim = c(0, .4), pch = 20, col = "steelblue")
abline(lm_mod_plm, lwd = 1.5)

# see: https://www.econometrics-with-r.org/10.4-regression-with-time-fixed-effects.html

# obtains a summary based on clustered standard errors (plm). adjusts for autocorrelation AND heteroskedasticity. 
coeftest(lm_mod_plm, vcov=vcovHC, type="HC1")

# obtains a summary based on heteroskedasticity-robust standard errors (no adj for heterosked. only)
coeftest(lm_mod, vcov = vcovHC, type="HC1")[1,]

# checks class of both models 
class(lm_mod_plm) # panel 
class(lm_mod) # lm 

# now, discuss results: 
```
 
 # rent perc change models -- lead 1 year 
```{r}
# # can't do lag for mod1 
# # mod1 <- lm(rent_perc_change_nominal ~ rent_price_ratio, data=df)
# # mod1
# 
# mod2 <- plm(lead(rent_perc_change_nominal,1) ~ rent_price_ratio + fips, index="fips", data=df) # note: i altered the code to make fips index... 
# mod2
# 
# mod3 <- plm(lead(rent_perc_change_nominal,1) ~ rent_price_ratio + fips + year, index = c("fips", "year"), model = "within", effect="twoways", data=df)
# mod3 
# 
# # in mod4, we want to include other county specific variables (we can pull this from the api!)
#  
# mod4 <- plm(lead(rent_perc_change_nominal,1) ~ rent_price_ratio + fips + year + interestRate + population + housing_value + gini_income_inequality_index + perc_units_occupied + perc_white + bach_deg_reported + pop_in_owner_occ_housing + total_housing_units + twelve_mo_median_hh_income, index=c("fips", "year"), model="within", effect="twoways", data=df) 
#               
#               
# #               household_type + bach_deg_reported + occupancy_status + vacancy_status + housing_units + twelve_mo_median_hh_income, index=c("fips", "year"), model="within", effect="twoways", data=df)
# # mod4
# 
# # plot 
# # plot(x = df$rent_price_ratio, y = df$rent_perc_change_nominal, xlab = "Rent-Price Ratio (2009 - 2019)", ylab = "Real Rent Percent Growth Rate (2009 - 2019)", ylim = c(0, .4), pch = 20, col = "steelblue")
# # abline(mod4, lwd = 8)

```

# hp growth models -- lead 1 year 

```{r}
# # can't do lag for mod 1 
# # mod1 <- lm(lead(house_perc_change_nominal,4) ~ rent_price_ratio, data=df)
# # mod1
# 
# mod5 <- plm(lead(house_perc_change_nominal,1) ~ rent_price_ratio + fips, index="fips", data=df) # note: i altered the code to make fips index... 
# mod5
# 
# mod6 <- plm(lead(house_perc_change_nominal,1) ~ rent_price_ratio + fips + year, index = c("fips", "year"), model = "within", effect="twoways", data=df)
# mod6 
# 
# # in mod4, we want to include other county specific variables (we can pull this from the api!)
#  
# mod7 <- plm(lead(house_perc_change_nominal,1) ~ rent_price_ratio + fips + year + population + housing_value + gini_income_inequality_index + household_type + bach_deg_reported + occupancy_status + vacancy_status + housing_units + twelve_mo_median_hh_income, index=c("fips", "year"), model="within", effect="twoways", data=df)
# mod7
# 
# # on hp 
# # mod8 <- plm(lead(house_perc_change_nominal,4) ~ rent_price_ratio + fips + year + population + housing_value + gini_income_inequality_index + household_type + bach_deg_reported + occupancy_status + vacancy_status + housing_units + twelve_mo_median_hh_income, index=c("fips", "year"), model="within", effect="twoways", data=df)
# # mod8

```


# examining pairwise correlation of variables to see if there are any that i can remove 

```{r}


# vars <- df[,c(7,8,9,10,11,12,13,14,15,16,17,18,19,20,26,47,48)]
# 
# #cor(vars, method = c("pearson", "kendall", "spearman"))
# 
# res <- cor(vars)
# print(round(res, 2))
# ```

```

# rent price growth - four years 

```{r}



# adjusted... 
mod20 <- plm(lead(rent_diff_nominal,4) ~ rent_price_ratio + fips, index="fips", data=df, vcov=vcovHC, na.action = na.omit) # note: i altered the code to make fips index... 
mod20

summary(mod20)

mod8 <- plm(lead(rent_perc_change_nominal,4) ~ rent_price_ratio + fips, index="fips", data=df, vcov=vcovHC, na.action = na.omit) # note: i altered the code to make fips index... 
mod8

mod9 <- plm(lead(rent_perc_change_nominal,4) ~ rent_price_ratio + fips + year, index = c("fips", "year"), model = "within", effect="twoways", data=df, vcov=vcovHC, na.action = na.omit)
mod9 

# in mod4, we want to include other county specific variables (we can pull this from the api!)
 
mod10 <- plm(lead(rent_perc_change_nominal,4) ~ rent_price_ratio + fips + year + interestRate + population + gini_income_inequality_index + perc_units_occupied + perc_white + perc_higher_ed + total_housing_units + twelve_mo_median_hh_income, index=c("fips", "year"), model="within", effect="twoways", data=df, vcov=vcovHC, na.action = na.omit)
mod10

```

```{r}
# testing for heteroskedasticity - rent growth model 

library(lmtest)

coeftest(mod8)
coeftest(mod8, vcovHC)
coeftest(mod8, vcovHC(mod8, method = "arellano"))

coeftest(mod9)
coeftest(mod9, vcovHC)
coeftest(mod9, vcovHC(mod9, method = "arellano"))

coeftest(mod10)
coeftest(mod10, vcovHC)
coeftest(mod10, vcovHC(mod10, method = "arellano")) # corrects for heteroskedasticity 

```
```{r}
# corrects each rent growth model for hetero sked 

correctMod08 <- coeftest(mod8, vcovHC(mod8, method = "arellano"))

correctMod09 <- coeftest(mod9, vcovHC(mod9, method = "arellano"))

correctMod10 <- coeftest(mod10, vcovHC(mod10, method = "arellano")) # 
```





# hp growth - four year lead 
```{r}

mod11 <- plm(lead(house_perc_change_nominal,4) ~ rent_price_ratio + fips, index="fips", data=df, vcov=vcovHC, na.action = na.omit) # note: i altered the code to make fips index... 
mod11

mod12 <- plm(lead(house_perc_change_nominal,4) ~ rent_price_ratio + fips + year, index = c("fips", "year"), model = "within", effect="twoways", data=df,vcov=vcovHC, na.action = na.omit)
mod12 

# in mod4, we want to include other county specific variables (we can pull this from the api!)
 
mod13 <- plm(lead(house_perc_change_nominal,4) ~ rent_price_ratio + fips + year + interestRate + population + gini_income_inequality_index + perc_units_occupied + perc_white + perc_higher_ed + total_housing_units + twelve_mo_median_hh_income, index=c("fips", "year"), model="within", effect="twoways", data=df, vcov=vcovHC, na.action = na.omit)
mod13

```


```{r}
# corrects for heteroskedasticity - HP model 
correctMod11 <- coeftest(mod11, vcovHC(mod8, method = "arellano"))

correctMod12 <- coeftest(mod12, vcovHC(mod9, method = "arellano"))

correctMod13 <- coeftest(mod13, vcovHC(mod10, method = "arellano")) 

sum <- summary(correctMod13, vcov=vcovHC)

sum <- summary(mod13, vcov = vcovHC)
sum
```


# Stargazer section: Generates a table

```{r}
# gather clustered standard errors in a list 
# 
seRent <- list(sqrt(diag(vcovHC(mod8, type="HC1"))), sqrt(diag(vcovHC(mod9, type="HC1"))), sqrt(diag(vcovHC(mod10, type="HC1"))))

seHP <- list(sqrt(diag(vcovHC(mod11, type="HC1"))), sqrt(diag(vcovHC(mod12, type="HC1"))), sqrt(diag(vcovHC(mod13, type="HC1"))))


# generate the table 

# tableTEST <- stargazer(mod1, mod2, mod3, mod4, header=FALSE, se=se, title="Linear Panel Regression Models of Rent Growth and Rent-Price-Ratio", model.numbers=FALSE, column.labels=c("(1)", "(2)", "(3)", "(4)", type="latex", out="Documents/GitHub/econThesisSpring/stargazertest.htmL")) # file name and loc

# rentGrowthTable1 <- stargazer(mod2, mod3, mod4, title="Linear Panel Regression Models of Rent Growth and Rent-Price Ratio", header=FALSE, se=se, type="html", out = "rentGrowthTable1.html")
# rentGrowthTable1
# 
# hpGrowthTable1 <- stargazer(mod5, mod6, mod7, title="Linear Panel Regression Models of House Price Growth and Rent-Price Ratio", header=FALSE, se=se, type="html", out = "housePriceTable1.html")
# hpGrowthTable1

rentGrowthTable4 <- stargazer(mod8, mod9, mod10, title="Linear Panel Regression Models of Rent Growth and Rent-Price Ratio", header=FALSE, se=seRent, type="html", out = "rentGrowthTable4.html")
rentGrowthTable4
  
hpGrowthTable4 <-  stargazer(mod11, mod12, mod13, title="Linear Panel Regression Models of Housing Growth and Rent-Price Ratio", header=FALSE, se=seHP, type="html", out = "housePriceTable4e.html")
hpGrowthTable4
```





