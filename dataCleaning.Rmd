---
title: "Data Cleaning"
author: "Maria Heeter"
date: "2/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# census, etc 
library(readxl)
library(censusapi)
library(tidycensus)
library(tidyverse)
library(viridis)
library(dplyr)
library(tidyr)
library(reshape2)
# maps - get rid of these 
library(maps)
library(usmap)
library(ggplot2)
library(censusapi)
```

## loads in both datasets 

```{r cars, message=FALSE, warning=FALSE}
# imports CPI Rent/ HPI sep graph 
RentHpiSep <- read_excel("CPI Rent and HPI (separated).xls",skip = 11)

# imports joint CPI/HPI graph 
RentHpiJoint <- read_excel("All-Transactions House Price Index for the United States:Consumer Price Index for All Urban Consumers- Rent of Primary Residence in U.S. City Average.xls", 
    skip = 10)

```

## Api Set up 

```{r, API setup, message=FALSE, error=FALSE}
# getting started w censusapi 
# sign up for an API key 

# add key to .Renviron 
Sys.setenv(CENSUS_KEY="6d7ca29c7ed75ec60a626822e88603fa6231567c")

# reload .Renviron 
readRenviron("~/.Renviron")

# check to see that expected key is output in R console 
Sys.getenv("CENSUS_KEY")
```

## API, ACS Information 
 
```{r, results='hide'}
# getting started - load the censusapi library 
v19 <- load_variables(2019, "acs1", cache=FALSE)
v09 <- load_variables(2009, "acs1", cache=FALSE)
``` 
## Adds in census key 

```{r, error=FALSE}
census_api_key("6d7ca29c7ed75ec60a626822e88603fa6231567c", install=TRUE,overwrite=TRUE)
# api key can be accessed: Sys.getenv("CENSUS_API_KEY").
```

# Uses API to load in variables included in dataset 

```{r, message=FALSE}
years <- 2009:2019 # includes the following years 
names(years) <- years

# here, see which variables are included 
priceVars <- c(contract_rent="B25058_001", housing_value="B25077_001",population="B01003_001", median_age_by_sex="B01002_001", gini_income_inequality_index = "B19083_001", white_pop = "B02001_002", total_race = "B02001_001", total_housing_units = "B25002_001", total_occupied = "B25002_002", ass_degree = "B15003_022", bach_degree = "B06009_005", ma_degree = "B15003_023", prof_school = "B15003_024", doct_deg = "B15003_025", total_school = "B15003_001", twelve_mo_median_hh_income = "B07411_001") 

pricesByYear <- map_dfr(years, ~{get_acs(geography="county", variables=priceVars, survey="acs1", year=.x
                                         )
  },.id="year")

view(pricesByYear) 

```

## Reshaping data 

```{r}
# long to wide using dcast() function in R: gets the table name and the list of columns to be kept constant (counties) and list of columns to be reshaped (variable) is passed as argument to reshape from long to wide 
long_to_wide = dcast(pricesByYear, year + GEOID + NAME ~ variable, value.var = "estimate") # NOTE: getting rid of margin of error 
```



## Adds new variables to dataset 

```{r, message=FALSE}

# changes from chars 
long_to_wide$year <- as.integer(long_to_wide$year)
long_to_wide$contract_rent <- as.integer(long_to_wide$contract_rent)

# renames to df 
df <- long_to_wide 

# multiplies contract rent by 12 for annual rent 
df <- df %>% mutate(contract_rent = contract_rent*12)

# good 
```

# checks for outliers 

```{r}
# removing outliers based on box plot visuals 

boxplot(df$contract_rent)$out
boxplot(df$housing_value)$out

```


```{r}

# inserts difference in year 
df$diff_year <- ifelse(long_to_wide$year > 2009, 1, 0) 

# inserts rent growth rate 
df <- df %>% arrange(year) %>% group_by(GEOID) %>% mutate(rent_diff_nominal = contract_rent - dplyr::lag(contract_rent), rent_perc_change_nominal = (rent_diff_nominal/ diff_year)/dplyr::lag(contract_rent) * 100, rent_price_ratio = (contract_rent/housing_value))

# get rid of figures missing either rent or housing prices using tidyr method 
df = df %>% drop_na(contract_rent) 
df = df %>% drop_na(housing_value)
df = df %>% drop_na(GEOID)

# now, add in the price deflator for personal consumption expenditures excluding good & energy to deflate nominal values
priceDeflator <- read_csv("priceDeflator.csv")
#priceDeflator = subset(priceDeflator, select = -c(...1) ) # gets rid of extra row 

# adds price deflator by year 
df <- merge(df, priceDeflator,by="year")

# split NAME column into county name and state 
df <- df %>% separate(NAME, c("county_name", "state_name"), ", ")

# changing col name 
colnames(df)[colnames(df)=="GEOID"] <- "fips"

## NEXT SECTION ADDS DATE COL 

# adds new month and date cols (01 as default, we don't have acccurate month/days)
df <- df %>% mutate(month = 01) %>% mutate(day = 01)

# need to make month, days into char instead of numeric
df$month <- as.character(df$month)
df$day <- as.character(df$day)
df$year <- as.character(df$year)

# checking class - all are chars 
class(df$day)
class(df$month)
class(df$year)

# now create new col named as "Date" by combining cols 
df$Date <- as.Date(with(df, paste(year,month,day,sep='-')), "%Y-%m-%d")

# now deletes unnecessary month and day cols - moves date next to year in df 
df = subset(df, select=-c(month, day))
df = df %>% relocate(Date, .after=year)

# renames date to lower cap 
df <- df %>% rename(date=Date)
```

## Adds real prices, pct changes 

```{r, message=FALSE}
# adding real hp and real rents 
df <- df %>% mutate(real_contract_rent = contract_rent * GDPDEF)
df <- df %>% mutate(real_housing_price = housing_value * GDPDEF)

# adding change in nominal housing growth, growth rate 
df <- df %>% group_by(fips) %>% arrange(year) %>% mutate(house_diff_nominal = housing_value - dplyr::lag(housing_value), house_perc_change_nominal = (house_diff_nominal/diff_year)/dplyr::lag(housing_value) * 100)

# inserts REAL rent growth rate 
df <- df %>% arrange(year) %>% group_by(fips) %>% mutate(rent_diff_real = real_contract_rent - dplyr::lag(real_contract_rent), rent_perc_change_real = (rent_diff_real/ diff_year)/dplyr::lag(real_contract_rent) * 100, rent_price_ratio = (real_contract_rent/real_housing_price))

# inserts REAL house price growth rate 
df <- df %>% group_by(fips) %>% arrange(year) %>% mutate(house_diff_real = real_housing_price - dplyr::lag(real_housing_price), house_perc_change_real = (house_diff_real/diff_year)/dplyr::lag(real_housing_price) * 100)

```

# adds mean value for rent price ratio, housing value, contract rent, rate perc, housing growth rate TAKING OUT 

```{r}

# adds mean value for rent price ratio (for each county)
# df <- df %>% group_by(fips) %>% arrange(year) %>% mutate(mean_rent_price_ratio = mean(rent_price_ratio, na.rm=TRUE)) # stripping the NAs
# 
# # calculates mean real housing value 
# df <- df %>% group_by(fips) %>% arrange(year) %>% mutate(mean_real_housing_value = mean(real_housing_price, na.rm=TRUE)) # strip NAs
# 
# # calculates mean nominal housing value
# df <- df %>% group_by(fips) %>% arrange(year) %>% mutate(mean_nom_housing_value = mean(housing_value, na.rm=TRUE)) # strips NAs
# 
# # mean real contract rent 
# df <- df %>% group_by(fips) %>% arrange(year) %>% mutate(mean_real_contract_rent = mean(real_contract_rent, na.rm=TRUE)) # strip NAs
# 
# # mean real nominal rent 
# df <- df %>% group_by(fips) %>% arrange(year) %>% mutate(mean_nom_contract_rent = mean(contract_rent, na.rm=TRUE))
# 
# # mean perc change rent (nom & real)
# df <- df %>% group_by(fips) %>% arrange(year) %>% mutate(mean_rent_pct_change = mean(rent_perc_change_nominal, na.rm=TRUE)) #  strip NAs 
# 
# # mean perc change housing (nom & real)
# df <- df %>% group_by(fips) %>% arrange(year) %>% mutate(mean_housing_pct_change = mean(house_perc_change_nominal, na.rm=TRUE)) # strip NAs
# 
# # just viewing county 
# 
# test <- df %>% subset(county_name == "Baldwin County", select = c("mean_nom_contract_rent", "mean_nom_housing_value", "mean_rent_price_ratio", "contract_rent", "housing_value", "year", "real_contract_rent", "real_housing_price"))
# view(test)

```

# RE DO: ADD MEAN VALUE FOR RENT-PRICE RATIO, HV, RENT. 

```{r}

# adds mean value for rent price ratio (for each county)
df <- df %>% group_by(year) %>% arrange(fips) %>% mutate(mean_rent_price_ratio = mean(rent_price_ratio, na.rm=TRUE)) # stripping the NAs

# calculates mean real housing value 
df <- df %>% group_by(year) %>% arrange(fips) %>% mutate(mean_real_housing_value = mean(real_housing_price, na.rm=TRUE)) # strip NAs

# calculates mean nominal housing value
df <- df %>% group_by(year) %>% arrange(fips) %>% mutate(mean_nom_housing_value = mean(housing_value, na.rm=TRUE)) # strips NAs

# mean real contract rent 
df <- df %>% group_by(year) %>% arrange(fips) %>% mutate(mean_real_contract_rent = mean(real_contract_rent, na.rm=TRUE)) # strip NAs

# mean real nominal rent 
df <- df %>% group_by(year) %>% arrange(fips) %>% mutate(mean_nom_contract_rent = mean(contract_rent, na.rm=TRUE))

# mean perc change rent (nom & real)
df <- df %>% group_by(year) %>% arrange(fips) %>% mutate(mean_rent_pct_change = mean(rent_perc_change_nominal, na.rm=TRUE)) #  strip NAs 

# mean perc change housing (nom & real)
df <- df %>% group_by(year) %>% arrange(fips) %>% mutate(mean_housing_pct_change = mean(house_perc_change_nominal, na.rm=TRUE)) # strip NAs
```

# Continues variable creation - this was creating mean-means but i don't think it's needed

```{r}
# # makes new cols. 1) average nom real rent by all counties, 2) avg nom real contract rent, 3) avg price-rent ratio 
# df <- df %>% group_by(year) %>% mutate(mean_mean_nom_contract_rent = mean(mean_nom_contract_rent)) 
# 
# df <- df %>% group_by(year) %>% mutate(mean_mean_nom_housing_value = mean(mean_nom_housing_value))
# 
# df <- df %>% group_by(year) %>% mutate(mean_mean_rent_price_ratio = mean(mean_rent_price_ratio))
# 
# # same above, but including mean real values 
# df <- df %>% group_by(year) %>% mutate(mean_mean_real_contract_rent = mean(mean_real_contract_rent)) %>% mutate(mean_mean_real_housing_value = mean(mean_real_housing_value)) %>% mutate(mean_mean_rent_price_ratio = mean(mean_rent_price_ratio))

```

# HELP!!!!!! FINISH INDEX!!!!!!!!! TAKEN OUT 

```{r}

# # NOTE: MAKE MEAN MEAN CONTRACT RENT NOMINAL 
# 
# # creates rent index values -- note: using 2009 *nominal* value
# df <- df %>% mutate(rentIndex = (mean_mean_nom_contract_rent/8856.543)*100) 
# # where the number is the 2009 mean *nominal* contract rent -- UPDATE
# 
# # creates house index values, where num is 2009 mean *nominal* housing value 
# df <- df %>% mutate(houseIndex = (mean_mean_nom_housing_value/200618.2)*100) # this part is fine 
# 
# # creates national rent_price_ratio 
# df <- df %>% mutate(rent_price_ratio_national=mean_mean_nom_contract_rent/mean_mean_nom_housing_value)
# 
# # national rent_price_ratio_national_index 
# df <- df %>% mutate(rent_price_ratio_national_index = rentIndex/houseIndex)
# 
# # create subset for year = 2019 
# mean2009 <- df %>% subset(year == 2009, select =mean_nom_contract_rent)
# mean(mean2009$mean_nom_contract_rent)


```

# HELP!!! finish index REDONE!!!
```{r}

# creates rent index values -- note: using 2009 *nominal* value
df <- df %>% mutate(rentIndex = (mean_nom_contract_rent/7859.106)*100) 
# where the number is the 2009 mean *nominal* contract rent -- UPDATE

# creates house index values, where num is 2009 mean *nominal* housing value 
df <- df %>% mutate(houseIndex = (mean_nom_housing_value/190020.4)*100) # this part is fine 

# creates national rent_price_ratio 
df <- df %>% mutate(rent_price_ratio_national=mean_nom_contract_rent/mean_nom_housing_value)

# national rent_price_ratio_national_index 
df <- df %>% mutate(rent_price_ratio_national_index = rentIndex/houseIndex)

# # create subset for year = 2019 
# mean2009 <- df %>% subset(year == 2009, select =mean_nom_contract_rent)
# mean(mean2009$mean_nom_contract_rent)

# calculates means 

mean2009 <- df %>% subset(year == 2009, select = c("mean_nom_contract_rent", "mean_nom_housing_value"))


mean(mean2009$mean_nom_contract_rent)
mean(mean2009$mean_nom_housing_value)


```



## adds leading 0s to fips codes of length four 

```{r, results='hide'}

# adds vars

df <- df %>% mutate(perc_white = white_pop/total_race)

df <- df %>% mutate(perc_units_occupied = total_occupied/total_housing_units)

df <- df %>% mutate(perc_higher_ed = (ass_degree + bach_degree + ma_degree + prof_school + doct_deg) / total_school)

# adds interest rate to DF 
interestRate <- read_csv("interestRate.csv")
df <- merge(df, interestRate,by="year")

stringr::str_pad(df$fips, 5, side="left", pad=0)

```


# saving dataframe 

```{r}
write.csv(df, "thesisDF.csv", row.names=TRUE, quote=FALSE) 
```



